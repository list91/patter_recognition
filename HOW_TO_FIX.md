# КАК ИСПРАВИТЬ ПРОБЛЕМУ: ПОШАГОВАЯ ИНСТРУКЦИЯ

## ЧТО ВЫЯСНИЛИ

**ГЛАВНАЯ ПРОБЛЕМА:** Mosaic аугментация сжимает объекты в 2 раза → они становятся невидимыми (4px вместо 8px)

**ДОКАЗАТЕЛЬСТВА:**
- Loss РАСТУТ вместо падения
- Все метрики = 0
- val/cls_loss = 76 (extreme overfitting)
- После mosaic: 8.5px → 4.3px (< 5px = критично)

---

## ШАГ 1: БЫСТРЫЙ ТЕСТ (3-5 минут)

### Вариант 1: Используем готовый конфиг
```bash
# Скопировать готовую конфигурацию
copy train_config_FIX_A.yaml train_config.yaml

# Запустить обучение
python train_and_test_confidence.py

# Ждём 3-5 минут...
```

### Вариант 2: Редактируем текущий конфиг вручную
```bash
# Открыть train_config.yaml

# Изменить только эти строки:
experiment_name: "fix_a_no_mosaic"
epochs: 30
imgsz: 1920
mosaic: 0.0    # ← ГЛАВНОЕ! Было 1.0
box: 10.0      # Было 7.5
cls: 1.0       # Было 0.5
lr0: 0.001     # Было 0.002

# Сохранить и запустить:
python train_and_test_confidence.py
```

---

## ШАГ 2: СМОТРИМ РЕЗУЛЬТАТ

### Успех (mAP > 0):
```
Если видите:
- mAP50 > 0 (было 0)
- confidence > 0.3 (было 0.22)
- cls_loss < 20 (было 40+)

ПРОБЛЕМА РЕШЕНА! Mosaic была виновата.
→ Переходите к ШАГ 3 (оптимизация)
```

### Неудача (mAP всё ещё = 0):
```
Если всё ещё mAP = 0:
- Проблема не только в mosaic
- Объекты слишком мелкие даже для imgsz=1920
→ Переходите к ШАГ 4 (агрессивное увеличение)
```

---

## ШАГ 3: ОПТИМИЗАЦИЯ (если ШАГ 1 успешен)

```bash
# Увеличить epochs для лучших результатов
epochs: 100    # Было 30

# Попробовать более мощную модель
model: "yolov8m.pt"  # Было yolov8s.pt

# Настроить loss weights (экспериментально)
box: 15.0
cls: 2.0

# Запустить финальное обучение:
python train_and_test_confidence.py
```

**Ожидаемый результат:** mAP50 > 0.5, confidence > 0.7

---

## ШАГ 4: АГРЕССИВНОЕ УВЕЛИЧЕНИЕ (если ШАГ 1 не помог)

```bash
# Используем FIX B конфигурацию
copy train_config_FIX_B.yaml train_config.yaml

# ВНИМАНИЕ: Медленно! 15-25 минут
python train_and_test_confidence.py
```

**Что делает FIX B:**
- imgsz=2560 (объекты станут 11×23px)
- yolov8m.pt (более мощная модель)
- box=15.0, cls=2.0 (максимальный фокус)
- epochs=50

**Если слишком медленно:**
- Уменьшите epochs до 30
- Или попробуйте ШАГ 5 (crops)

---

## ШАГ 5: СОЗДАНИЕ CROPS (РЕКОМЕНДУЕМОЕ решение)

**Идея:** Вместо обучения на полном 4963×3509 изображении, вырезать crops вокруг объектов.

### Преимущества:
- Объекты будут 15-30px при imgsz=640 (отлично видимы)
- Из 1 изображения → 12 crops (больше данных!)
- Быстрое обучение
- Можно использовать mosaic

### Как сделать:
```python
# Создайте скрипт create_crops.py
# (Псевдо-код, нужна реализация)

for each annotation in train_01.txt:
    x, y = center of object
    crop = image[y-400:y+400, x-400:x+400]  # 800×800 crop
    save(crop, f"crop_{i}.jpg")
    update_label(crop, f"crop_{i}.txt")
```

**После создания crops:**
```yaml
# train_config.yaml
imgsz: 640     # Теперь можно использовать меньше!
mosaic: 1.0    # Можно включить обратно
```

---

## ШАГ 6: СБОР БОЛЬШЕ ДАННЫХ (долгосрочно)

**Текущая ситуация:** 1 изображение, 12 объектов
**Минимум нужно:** 50-100 изображений, 500-1000 объектов

**Без достаточных данных любая модель будет переобучаться!**

Что делать:
1. Разметить больше схем
2. Использовать data augmentation (но БЕЗ mosaic для мелких объектов!)
3. Рассмотреть synthetic data generation

---

## ДИАГНОСТИЧЕСКИЕ ФАЙЛЫ

Созданы следующие инструменты:

```
diagnose_resize.py         - Визуализация размеров после resize
test_mosaic_impact.py      - Проверка влияния mosaic
full_diagnostics.py        - Полная диагностика всех проблем
analysis_loss.py           - Анализ loss графиков
test_pretrained.py         - Тест базовой модели

DIAGNOSIS_REPORT.md        - Полный отчёт с техническими деталями
train_config_FIX_A.yaml    - Готовая конфигурация (быстрый фикс)
train_config_FIX_B.yaml    - Готовая конфигурация (агрессивный)
```

Используйте их для дальнейшей диагностики.

---

## КРИТЕРИИ УСПЕХА

### Минимальный успех:
- mAP50 > 0.1
- Confidence > 0.3
- Модель детектирует хотя бы половину объектов

### Хороший результат:
- mAP50 > 0.5
- Confidence > 0.7
- Precision > 0.8, Recall > 0.6

### Отличный результат:
- mAP50 > 0.9
- Confidence > 0.9
- Precision > 0.95, Recall > 0.9

---

## ЧТО ДЕЛАТЬ ЕСЛИ НИЧЕГО НЕ ПОМОГЛО

1. **Проверьте разметку визуально:**
   ```bash
   python visualize_gt.py  # Если есть такой скрипт
   ```

2. **Попробуйте другие архитектуры:**
   - YOLOv5 (может лучше с мелкими объектами)
   - Faster R-CNN (медленнее, но точнее)

3. **Обратитесь к документации:**
   - Прочитайте DIAGNOSIS_REPORT.md
   - Запустите full_diagnostics.py

4. **Получите больше данных** - это самое важное!

---

**Удачи! Начните с ШАГ 1.**
